<IfModule mod_rewrite.c>
RewriteEngine On
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

<IfModule mod_headers.c>
    Header set Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self';"
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "DENY"
    Header set X-XSS-Protection "1; mode=block"
    Header set Strict-Transport-Security "max-age=31536000; includeSubDomains"  # Enforce HTTPS
    Header set Referrer-Policy "no-referrer-when-downgrade"  # Control referrer information
    Header set Feature-Policy "geolocation 'none'; microphone 'none'; camera 'none'"  # Control features and APIs

    # Ensure Vary header is set for proper caching
    Header append Vary Accept-Encoding

    # Cache control for static resources
    <FilesMatch "\.(ico|jpg|jpeg|png|gif|js|css|webp|woff|woff2|ttf|svg)$">
        Header set Cache-Control "max-age=3600, public"  # 1 hour
        Header set Expires "access plus 1 hour"
    </FilesMatch>
</IfModule>

<IfModule mod_deflate.c>
    # Fallback to gzip compression
    AddOutputFilterByType DEFLATE text/html text/css application/javascript text/javascript text/plain text/xml application/xml application/xhtml+xml application/rss+xml application/atom+xml application/json application/ld+json application/vnd.ms-fontobject application/x-font-ttf font/opentype font/otf font/ttf image/svg+xml

    # Remove browser bugs
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    Header append Vary User-Agent
</IfModule>

<IfModule mod_brotli.c>
    # Enable Brotli compression
    AddOutputFilterByType BROTLI_COMPRESS text/html text/css application/javascript text/javascript text/plain text/xml application/xml application/xhtml+xml application/rss+xml application/atom+xml application/json application/ld+json application/vnd.ms-fontobject application/x-font-ttf font/opentype font/otf font/ttf image/svg+xml
</IfModule>
